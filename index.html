<!DOCTYPE HTML>

<head>
    <link rel="stylesheet" type="text/css" href="style.css">
</head>

<body>
    <div class="wrapper">
        <div class="entry" id="v0">
            <form>
                <input type="radio" name="0" value="1"> John Doe<br />
                <input type="radio" name="0" value="2"> Jane Doe<br />
                <button type="button" onclick="vote(0)">Vote</button>
            </form>
        </div>
        <div class="votes" id="n0" style="display: none;">
            <p>John Doe</p>
            <progress id="0p0" value="32" max="100">32%</progress>
            <p>Jane Doe</p>
            <progress id="0p1" value="68" max="100">68%</progress>
        </div>
        <div class="entry" id="v1">
            <form>
                <input type="radio" name="1" value="1"> John Doe<br />
                <input type="radio" name="1" value="2"> Jane Doe<br />
                <button type="button" onclick="vote(1)">Vote</button>
            </form>
        </div>
        <div class="votes" id="n1" style="display: none;">
            <p>John Doe</p>
            <progress id="1p0" value="32" max="100">32%</progress>
            <p>Jane Doe</p>
            <progress id="1p1" value="68" max="100">68%</progress>
        </div>
    </div>
    <script type="text/javascript">
        function vote(entry) {
            var radios = document.querySelectorAll('input[type="radio"]:checked');
            if (!(radios.length > 0)) return alert("please vote");

            var xhr = new XMLHttpRequest();
            var value;
            var choices = document.getElementsByName(entry);
            console.log(choices);
            if (choices[0].checked) {
                value = 0;
            } else {
                value = 1;
            }

            var post = {
                id: entry,
                value: value
            }

            xhr.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    getVotes(entry);
                }
            }

            var json = JSON.stringify(post);
            xhr.open("POST", "http://teacher-madness.glitch.me/vote/");
            xhr.setRequestHeader("content-type", "application/json");
            xhr.send(json);
        }

        async function getVotes(entry) {
            await fetch("http://teacher-madness.glitch.me/votes?id=1", {
                method: "GET",
                headers: {
                    'Content-Type': 'application/json'
                },
            })
            .then(response => response.json())
            .then(res => displayVotes(entry, res))
            .catch(err => console.error(err));
        }

        function displayVotes (entry, votes) {
            document.getElementById(`v${entry}`).style.display = "none";
            document.getElementById(`n${entry}`).style.display = "block";

            var b1 = document.getElementById(`${entry}p0`);
            var b2 = document.getElementById(`${entry}p1`);

            var tot = votes.vote1 + votes.vote2;
            var v1 = Math.round((votes.vote1 / tot) * 100);
            var v2 = Math.round((votes.vote2 / tot) * 100);

            b1.setAttribute("value", v1);
            b2.setAttribute("value", v2);

            console.log(votes);
        }
    </script>
</body>

U=&m-G~[N9i5
?-Y}C,acM:6
